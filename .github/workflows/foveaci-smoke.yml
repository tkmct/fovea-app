name: FoveaCI Smoke

on:
  workflow_dispatch:
    inputs:
      foveaci_repo:
        description: "owner/repo for foveaci"
        required: true
        default: "tkmct/foveaci"
      foveaci_ref:
        description: "branch/tag/sha for foveaci"
        required: true
        default: "main"

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout example app
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install app dependencies
        run: npm ci

      - name: Start app
        run: npm start >/tmp/example-app.log 2>&1 &

      - name: Wait for app
        run: npx wait-on http://localhost:3456/api/health

      - name: Checkout foveaci
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.foveaci_repo }}
          ref: ${{ inputs.foveaci_ref }}
          path: foveaci

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install foveaci dependencies
        working-directory: foveaci
        run: pnpm install --frozen-lockfile

      - name: Build foveaci
        working-directory: foveaci
        run: pnpm build

      - name: Install Playwright browser
        working-directory: foveaci
        run: npx playwright install chromium

      - name: Run foveaci against rich app
        working-directory: foveaci
        run: |
          pnpm fov run \
            --config ../config/foveaci/basic.yml \
            --out ../artifacts/fov-run

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: foveaci-smoke-artifacts
          path: |
            artifacts
            /tmp/example-app.log
