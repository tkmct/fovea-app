name: PR UX Eval

on:
  pull_request:
    types: [opened, reopened, synchronize, edited, labeled, unlabeled]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: pr-ux-eval-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-ux-eval:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install app dependencies
        run: npm ci

      - name: Checkout foveaci tool
        uses: actions/checkout@v4
        with:
          repository: tkmct/foveaci
          ref: a683c8c
          path: foveaci-tool

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install foveaci dependencies
        working-directory: foveaci-tool
        run: pnpm install --frozen-lockfile

      - name: Build foveaci
        working-directory: foveaci-tool
        run: pnpm build

      - name: Build PR metadata
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const pr = context.payload.pull_request;
            const metadata = {
              number: pr.number,
              title: pr.title,
              body: pr.body || "",
              labels: pr.labels.map((label) => label.name),
              url: pr.html_url,
            };
            fs.mkdirSync("artifacts", { recursive: true });
            fs.writeFileSync("artifacts/pr.json", JSON.stringify(metadata, null, 2));

      - name: Discover scenarios
        run: |
          node ./foveaci-tool/dist/bin/fov.js discover \
            --base "${{ github.event.pull_request.base.sha }}" \
            --head "${{ github.event.pull_request.head.sha }}" \
            --pr-metadata ./artifacts/pr.json \
            --out ./artifacts/pr-discovery

      - name: Render preview comment
        run: |
          node ./foveaci-tool/scripts/render_pr_summary.mjs \
            --scenario-file ./artifacts/pr-discovery/discovered-scenarios.yml \
            --preview-file ./artifacts/pr-discovery/scenario-preview.md \
            --pr-metadata ./artifacts/pr.json \
            --artifact-name "pr-ux-eval-${{ github.event.pull_request.number }}" \
            --local-serve-cmd "node <foveaci_root>/dist/bin/fov.js serve-report --dir <artifact_root>/artifacts/pr-eval/report --port 4173" \
            --local-open-cmd "http://localhost:4173/index.html" \
            --output ./artifacts/pr-comment.md

      - name: Post preview comment
        run: |
          node ./foveaci-tool/scripts/post_pr_comment.mjs \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --token "${{ github.token }}" \
            --body-file ./artifacts/pr-comment.md

      - name: Install Playwright browser
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        working-directory: foveaci-tool
        run: npx playwright install chromium

      - name: Start app
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        run: npm start >/tmp/fovea-app.log 2>&1 &

      - name: Wait for app health
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        run: npx wait-on http://localhost:3456/api/health

      - name: Approve scenarios for execution
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        run: |
          node ./foveaci-tool/scripts/approve_scenarios.mjs \
            --input ./artifacts/pr-discovery/discovered-scenarios.yml \
            --output ./artifacts/pr-discovery/approved-scenarios.yml \
            --min-confidence 0.5

      - name: Run PR evaluation
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        run: |
          node ./foveaci-tool/dist/bin/fov.js pr-eval \
            --config ./config/foveaci/basic.yml \
            --scenario-file ./artifacts/pr-discovery/approved-scenarios.yml \
            --pr-metadata ./artifacts/pr.json \
            --out ./artifacts/pr-eval \
            --advisor on \
            --skip-label-check

      - name: Render result comment
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        run: |
          node ./foveaci-tool/scripts/render_pr_summary.mjs \
            --scenario-file ./artifacts/pr-discovery/approved-scenarios.yml \
            --preview-file ./artifacts/pr-discovery/scenario-preview.md \
            --pr-metadata ./artifacts/pr.json \
            --candidate-dir ./artifacts/pr-eval \
            --artifact-name "pr-ux-eval-${{ github.event.pull_request.number }}" \
            --local-serve-cmd "node <foveaci_root>/dist/bin/fov.js serve-report --dir <artifact_root>/artifacts/pr-eval/report --port 4173" \
            --local-open-cmd "http://localhost:4173/index.html" \
            --output ./artifacts/pr-comment.md

      - name: Validate replay artifacts
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        run: |
          test -f ./artifacts/pr-eval/report/index.html
          test -f ./artifacts/pr-eval/report/report-data.json

      - name: Post result comment
        if: contains(github.event.pull_request.labels.*.name, 'ux-eval-approved')
        run: |
          node ./foveaci-tool/scripts/post_pr_comment.mjs \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --token "${{ github.token }}" \
            --body-file ./artifacts/pr-comment.md

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-ux-eval-${{ github.event.pull_request.number }}
          path: |
            artifacts
            /tmp/fovea-app.log
