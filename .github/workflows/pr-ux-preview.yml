name: PR UX Preview

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: pr-ux-preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout foveaci tool
        uses: actions/checkout@v4
        with:
          repository: tkmct/foveaci
          ref: feature/pr-ux-eval-tooling
          path: foveaci-tool

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: foveaci-tool/pnpm-lock.yaml

      - name: Install foveaci dependencies
        working-directory: foveaci-tool
        run: pnpm install --frozen-lockfile

      - name: Build foveaci
        working-directory: foveaci-tool
        run: pnpm build

      - name: Build PR metadata
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const pr = context.payload.pull_request;
            const metadata = {
              number: pr.number,
              title: pr.title,
              body: pr.body || "",
              labels: pr.labels.map((label) => label.name),
              url: pr.html_url,
            };
            fs.mkdirSync("artifacts", { recursive: true });
            fs.writeFileSync("artifacts/pr.json", JSON.stringify(metadata, null, 2));

      - name: Discover scenarios
        run: |
          node ./foveaci-tool/dist/bin/fov.js discover \
            --base "${{ github.event.pull_request.base.sha }}" \
            --head "${{ github.event.pull_request.head.sha }}" \
            --pr-metadata ./artifacts/pr.json \
            --out ./artifacts/pr-discovery

      - name: Render preview comment
        run: |
          node ./foveaci-tool/scripts/render_pr_summary.mjs \
            --scenario-file ./artifacts/pr-discovery/discovered-scenarios.yml \
            --preview-file ./artifacts/pr-discovery/scenario-preview.md \
            --pr-metadata ./artifacts/pr.json \
            --artifact-name "pr-ux-eval-${{ github.event.pull_request.number }}" \
            --approval-mode reaction \
            --approval-reaction +1 \
            --approval-min-permission write \
            --local-serve-cmd "bun run serve-report:artifact" \
            --local-open-cmd "http://localhost:4173/index.html" \
            --output ./artifacts/pr-comment.md

      - name: Post preview comment
        run: |
          node ./foveaci-tool/scripts/post_pr_comment.mjs \
            --repo "${{ github.repository }}" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --token "${{ github.token }}" \
            --body-file ./artifacts/pr-comment.md

      - name: Upload preview artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-ux-preview-${{ github.event.pull_request.number }}
          path: artifacts/pr-discovery
